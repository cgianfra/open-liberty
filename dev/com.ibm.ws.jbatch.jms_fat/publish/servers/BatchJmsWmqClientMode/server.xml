
<server>
    <featureManager>
        <feature>wmqJmsClient-2.0</feature>
        <feature>batchManagement-1.0</feature>	
    </featureManager>
	
	<include optional="true" location="../fatTestPorts.xml"/>
	
   <!-- wmq resource adapter -->	
   <variable name="wmqJmsClient.rar.location" value="${server.config.dir}/wmq.wlp.rar" />
   
   <!-- ra with the fix to recognized liberty is running on z/OS -->
   <!-- variable name="wmqJmsClient.rar.location" value="${server.config.dir}/wmq.jmsra.rar" /-->
   
     <batchPersistence jobStoreRef="BatchDatabaseStore" />

    <databaseStore id="BatchDatabaseStore" dataSourceRef="batchDB" schema="JBATCH" tablePrefix="" />

	<library id="DerbyLib">
	    <file name="${shared.resource.dir}/derby/derby.jar"/>
	</library>
	
	<!-- The following configures in-memory Derby.  For Derby on disk, which is needed if the database
    is required beyond a single server start, configure the databaseName with a file location such as:
    databaseName="${shared.config.dir}/data/derbydb" -->

	<dataSource id="batchDB" jndiName="jdbc/batch">
		<jdbcDriver libraryRef="DerbyLib" />
		<properties.derby.embedded databaseName="memory:BATCHDB"
			loginTimeout="360s"
			createDatabase="create" user="user" password="pass" />
	</dataSource>				  
	
	 	<!--  Both use the same DB -->
	<dataSource id="BonusPayoutNoTran" jndiName="jdbc/BonusPayoutNoTranDS" type="javax.sql.ConnectionPoolDataSource" transactional="false">
		<jdbcDriver libraryRef="DerbyLib" />
        <properties.derby.embedded databaseName="memory:BonusPayoutDB"
			createDatabase="create" user="user" password="pass" />
	</dataSource>

	<dataSource id="BonusPayout" jndiName="jdbc/BonusPayoutDS" type="javax.sql.XADataSource">
		<jdbcDriver libraryRef="DerbyLib" />
        <properties.derby.embedded databaseName="memory:BonusPayoutDB"
			createDatabase="create" user="user" password="pass" />
	</dataSource>

    <keyStore id="defaultKeyStore" location="${server.config.dir}/resources/security/key.p12" type="PKCS12" password="{xor}EzY9Oi0rJg==" />
	    <!--keyStore id="defaultKeyStore" password="Liberty"/-->
    <basicRegistry id="basic" realm="ibm/api">
        <user name="bob" password="bobpwd"/>
        <user name="jane" password="janepwd"/>
    </basicRegistry>
	
    <administrator-role><user>bob</user></administrator-role>

	<!-- Everyone is a batch admin for non security related tests -->
	<authorization-roles id="com.ibm.ws.batch">
		<security-role name="batchAdmin">
			<user name="bob" />
			<user name="jane" />
		</security-role>
	</authorization-roles>
	
	
	<batchJmsDispatcher />
	<batchJmsExecutor activationSpecRef="batchActivationSpec" queueRef="batchJobSubmissionQueue"/>
	<batchJmsEvents connectionFactoryRef="batchConnectionFactory" />
		
	
	 <authData id="activation1auth" password="passw0rd" user="aaaaa"/>
	 
	<!-- note that message selector need space around the equal sign-->
	<jmsActivationSpec id="batchActivationSpec">
		<properties.wmqJms destinationRef="batchJobSubmissionQueue" 
						   messageSelector="com_ibm_ws_batch_applicationName = 'SimpleBatchJob' OR com_ibm_ws_batch_applicationName = 'BonusPayout'"
						   transportType="CLIENT" 
						   hostName="localhost"
						   port="1414"
						   channel="BATCHCH"			
						   queueManager="qm1" />		
	</jmsActivationSpec>
	 
	<jmsConnectionFactory id="batchConnectionFactory" jndiName="jms/batch/connectionFactory">
		<properties.wmqJms 
			 transportType="CLIENT" 
			 hostName="localhost"
			 port="1414"
			 channel="BATCHCH"	
			 queueManager="qm1"  />	
	</jmsConnectionFactory>
		
			
	<!-- baseQueueName is the queue defined on WMQ system -->	
	<jmsQueue id="batchJobSubmissionQueue" jndiName="jms/batch/jobSubmissionQueue">
		<properties.wmqJms
			baseQueueName="BATCHQ" 
			priority="QDEF" 
			baseQueueManagerName="qm1"/>
	</jmsQueue>
	
	
<!--  This is used by the test app MDB activation spec to filter for topics in the topic tree.
	xxx//. match 0 or more level 
	xxx//* match 1 or more level
	xxx// is not valid
	-->
	<jmsTopic id="batchJobTopic" jndiName="jms/batch/batchJobTopic">
		<properties.wmqJms baseQueueManagerName="qm1"  baseTopicName="batch/#"/>
	</jmsTopic>
	
	<!-- test mdb application to receive job events -->
	<jmsActivationSpec id="jmsmdb/jmsmdb/TopicSpaceMDB" authDataRef="activation1auth">
		<properties.wmqJms destinationRef="batchJobTopic" 
             transportType="CLIENT" 
             destinationType="javax.jms.Topic"
             queueManager="qm1" 
             hostName="localhost"
             port="1414"
             channel="BATCHCH" >
        </properties.wmqJms>
	</jmsActivationSpec>
	
	<wmqJmsClient reconnectionRetryInterval="10000"/>
	<transaction totalTranLifetimeTimeout="6m"/>
	
	<javaPermission className="java.net.SocketPermission" name="*" actions="connect,resolve"/>
</server>
